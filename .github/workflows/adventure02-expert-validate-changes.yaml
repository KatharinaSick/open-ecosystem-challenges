# ============================================================================
# OpenTofu Validation Workflow
# ============================================================================
# Runs on pull requests to validate OpenTofu changes.
# ============================================================================

name: ðŸŒ†ðŸ”´ | ðŸ§ Validate Infrastructure Changes (Adventure 02 - Expert)

on:
  pull_request:
    paths:
      - "adventures/02-building-cloudhaven/expert/**"
      - ".github/workflows/adventure02-expert-*.yaml"

concurrency:
  group: pr-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  WORKING_DIR: adventures/02-building-cloudhaven/expert
  TOFU_VERSION: "1.11.2"
  # This is only needed because we're using a mock GCS backend.
  # In production, you'd remove this.
  # The actual value is set during startup.
  STORAGE_EMULATOR_HOST: "https://probable-space-succotash-x5rwr55v442p554-30104.app.github.dev"

jobs:
  # ----------------------------------------------------------------------------
  # Validate & Plan
  # ----------------------------------------------------------------------------
  validate-and-plan:
    name: ðŸ“‹ Validate & Plan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}
          tofu_wrapper: false

      - name: ðŸ”Ž Validate & Plan
        uses: OP5dev/TF-via-PR@v13
        with:
          working-directory: ${{ env.WORKING_DIR }}
          command: plan
          arg-lock: false
          tool: tofu
          format: true
          validate: true

  # ----------------------------------------------------------------------------
  # Test
  # ----------------------------------------------------------------------------
  test:
    name: ðŸ§ª Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}
          tofu_wrapper: false

      - name: ðŸ“¦ Initialize
        working-directory: ${{ env.WORKING_DIR }}
        run: tofu init -backend=false

      - name: ðŸ§ª Run tests
        working-directory: ${{ env.WORKING_DIR }}
        run: tofu test

  # ----------------------------------------------------------------------------
  # Security Scan
  # ----------------------------------------------------------------------------
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 5

    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”’ Scan for Vulnerabilities
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'config'
          scan-ref: ${{ env.WORKING_DIR }}
          exit-code: 0
          severity: 'CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN'
          format: 'json'
          output: 'vulnerabilities.json'

      - name: ðŸ“Š Count Vulnerabilities
        id: count
        run: |
          count_severity() {
            jq "[.Results[]?.Misconfigurations[]? | select(.Severity==\"$1\")] | length" "$2" 2>/dev/null || echo 0
          }
          
          echo "critical=$(count_severity CRITICAL vulnerabilities.json)" >> $GITHUB_OUTPUT
          echo "high=$(count_severity HIGH vulnerabilities.json)" >> $GITHUB_OUTPUT
          echo "medium=$(count_severity MEDIUM vulnerabilities.json)" >> $GITHUB_OUTPUT
          echo "low=$(count_severity LOW vulnerabilities.json)" >> $GITHUB_OUTPUT
          echo "unknown=$(count_severity UNKNOWN vulnerabilities.json)" >> $GITHUB_OUTPUT

      - name: ðŸ’¬ Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            const body = `## ðŸ”’ Security Scan Results
            
            Trivy scanned your infrastructure code for potential security issues.
            
            | Severity | Count |
            |----------|-------|
            | ðŸ”´ Critical | ${{ steps.count.outputs.critical }} |
            | ðŸŸ  High | ${{ steps.count.outputs.high }} |
            | ðŸŸ¡ Medium | ${{ steps.count.outputs.medium }} |
            | ðŸŸ¢ Low | ${{ steps.count.outputs.low }} |
            | âšª Unknown | ${{ steps.count.outputs.unknown }} |
            
            > âš ï¸ Critical and High vulnerabilities must be resolved before merging.`;
            
            core.summary.addRaw(body).write();
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: ðŸš« Fail on Blocking Vulnerabilities
        if: steps.count.outputs.critical > 0 || steps.count.outputs.high > 0
        run: |
          echo "::error::Found blocking vulnerabilities: ${{ steps.count.outputs.critical }} critical, ${{ steps.count.outputs.high }} high"
          exit 1
