name: ðŸŒ†ðŸ”´ | ðŸ” Detect Infrastructure Drift (Adventure 02 - Expert)
on:
  workflow_dispatch:

# Ensure only one drift detection runs at a time
concurrency:
  group: drift-detection
  cancel-in-progress: false

env:
  WORKING_DIR: adventures/02-building-cloudhaven/expert
  # This is only needed because we're using a mock GCS backend.
  # In production, you'd remove this.
  # The actual value is set during startup.
  STORAGE_EMULATOR_HOST: "https://cautious-cod-7qxvxq94pjcp64g-30104.app.github.dev"

jobs:
  detect-drift:
    name: Detect Infrastructure Drift
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: write
      pull-requests: write

    steps:
      # ----------------------------------------------------------------------
      # Setup
      # ----------------------------------------------------------------------
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: "1.11.2"
          tofu_wrapper: false

      # ----------------------------------------------------------------------
      # Initialize and Plan
      # ----------------------------------------------------------------------
      - name: ðŸ“¦ Initialize OpenTofu
        working-directory: ${{ env.WORKING_DIR }}
        run: tofu init

      - name: ðŸ“ Run OpenTofu Plan
        id: plan
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          tofu plan -detailed-exitcode
          EXIT_CODE=$?

          if [ "$EXIT_CODE" -eq 2 ]; then
            echo "âš ï¸ Drift detected!"
            echo "drift=true" >> $GITHUB_OUTPUT
          elif [ "$EXIT_CODE" -eq 0 ]; then
            echo "âœ… No drift detected."
            echo "drift=false" >> $GITHUB_OUTPUT
          else
            echo "âŒ Plan failed with exit code $EXIT_CODE"
            exit 1
          fi

      # ----------------------------------------------------------------------
      # Generate Drift Log Entry (only if drift detected)
      # ----------------------------------------------------------------------
      - name: ðŸ“ Create drift log entry
        if: steps.plan.outputs.drift == 'true'
        working-directory: ${{ env.WORKING_DIR }}
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          RUN_NUMBER: ${{ github.run_number }}
          TRIGGER: ${{ github.event_name }}
        run: |
          LOG_DIR="drift-log"

          mkdir -p "$LOG_DIR"
          FILENAME="$LOG_DIR/$(date -u +%Y%m%d-%H%M%S).md"
          PLAN=$(tofu show tfplan -no-color)

          {
            echo "# Drift Detected"
            echo ""
            echo "- **Run:** [#${RUN_NUMBER}](${RUN_URL})"
            echo "- **Trigger:** ${TRIGGER}"
            echo ""
            echo "## Detected Drift"
            echo ""
            echo '```'
            echo "$PLAN"
            echo '```'
            echo ""
            echo "---"
            echo "*Auto-generated by drift detection workflow*"
          } > "$FILENAME"

      # ----------------------------------------------------------------------
      # Create PR (if drift detected)
      # ----------------------------------------------------------------------
      - name: ðŸ”€ Create Pull Request
        if: steps.plan.outputs.drift == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: reconcile infrastructure drift"
          title: "ðŸš¨ Infrastructure Drift Detected"
          body: |
            ## ðŸš¨ Infrastructure Drift Detected

            Drift was detected in the CloudHaven infrastructure.
            Review the changes below and merge this PR to reconcile.

            ðŸ“‹ See the drift log entry for details.

            ---
            *Generated automatically by drift detection workflow*
          branch: fix/drift-${{ github.run_number }}
          delete-branch: true
          add-paths: |
            ${{ env.WORKING_DIR }}/drift-log/*.md
          labels: |
            drift
            infrastructure
            automated

      # ----------------------------------------------------------------------
      # Summary
      # ----------------------------------------------------------------------
      - name: ðŸ“ Job Summary
        run: |
          echo "## Drift Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.plan.outputs.drift }}" == "false" ]; then
            echo "âœ… **No drift detected** - Infrastructure matches desired state" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸš¨ **Drift detected** - A PR has been created to reconcile" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the PR" >> $GITHUB_STEP_SUMMARY
            echo "2. Merge to trigger \`tofu apply\`" >> $GITHUB_STEP_SUMMARY
          fi