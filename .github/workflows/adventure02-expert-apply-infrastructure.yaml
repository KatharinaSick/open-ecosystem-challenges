# ============================================================================
# Apply Workflow
# ============================================================================
# This workflow runs when changes are pushed to main.
# It applies the OpenTofu configuration to reconcile the infrastructure.
#
# Trigger: Push to main branch
# ============================================================================

name: ðŸŒ†ðŸ”´ | ðŸš€ Apply Infrastructure (Adventure 02 - Expert)

on:
  push:
    branches: [main]
    paths:
      - "adventures/02-building-cloudhaven/expert/**"
      - ".github/workflows/adventure02-expert-*.yaml"

# Ensure only one apply runs at a time
concurrency:
  group: apply-infrastructure
  cancel-in-progress: false

env:
  WORKING_DIR: adventures/02-building-cloudhaven/expert
  TOFU_VERSION: "1.11.2"
  # This is only needed because we're using a mock GCS backend.
  # In production, you'd remove this.
  # The actual value is set during startup.
  STORAGE_EMULATOR_HOST: "https://redesigned-guacamole-j6gjg65w753jqv7-30104.app.github.dev"

jobs:
  apply:
    name: ðŸš€ Apply Infrastructure Changes
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      actions: read   # Required to identify workflow run.
      checks: write   # Required to add status summary.
      contents: read  # Required to checkout repository.

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}
          tofu_wrapper: false

      - name: ðŸš€ Apply
        uses: OP5dev/TF-via-PR@v13
        with:
          working-directory: ${{ env.WORKING_DIR }}
          command: apply
          arg-auto-approve: true
          tool: tofu
          format: true
          validate: true
          expand-summary: true
